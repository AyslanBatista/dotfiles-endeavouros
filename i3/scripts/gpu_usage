#!/bin/bash

# Se houver um clique, abra o btop (o script wrapper da CPU já lida com isso)
if [ -n "$BLOCK_BUTTON" ]; then
    case $BLOCK_BUTTON in
        1) kitty --title="System Monitor" btop & ;;
        3) kitty --title="GPU Info" --hold sh -c "nvidia-smi || (echo 'NVIDIA GPU Info:' && lspci | grep VGA)" & ;;
    esac
    exit 0
fi

# Executa o nvidia-smi para obter o uso da GPU
gpu_usage=$(nvidia-smi --query-gpu=utilization.gpu --format=csv,noheader,nounits 2>/dev/null)

# Verificar se o comando foi executado com sucesso
if [ $? -ne 0 ] || [ -z "$gpu_usage" ]; then
    echo "N/A"
    echo "N/A" 
    exit 0
fi

# Remove espaços extras e garante que é um número
gpu_usage=$(echo "$gpu_usage" | tr -d ' ')

# Validar se é um número
if ! [[ "$gpu_usage" =~ ^[0-9]+$ ]]; then
    echo "N/A"
    echo "N/A"
    exit 0
fi

# short text
echo "${gpu_usage}%"

# full text (required by i3blocks)
echo "${gpu_usage}%"

# Colors based on GPU usage
if [ "$gpu_usage" -gt 90 ]; then
    echo "#FF0000"  # Red - Very high usage
elif [ "$gpu_usage" -gt 70 ]; then
    echo "#FFA500"  # Orange - High usage
elif [ "$gpu_usage" -gt 50 ]; then
    echo "#FFFF00"  # Yellow - Moderate usage
fi
